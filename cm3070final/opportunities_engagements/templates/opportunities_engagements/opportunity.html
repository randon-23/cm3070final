{% extends 'base/base_authenticated.html' %}
{% load static %}
{% block title %}Opportunities{% endblock %}
{% block auth_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&callback=initAutocomplete" async defer></script>
<script src="{% static 'js_frontend-scripts/profile-processes.js.js' %}"></script>
<script src="{% static 'js_frontend-scripts/opportunities-search-processes.js' %}"></script>
<script src="{% static 'js_frontend-scripts/opportunities-engagements-processes.js' %}"></script>

<!-- If the user accessing is the organization who created the opportunity, the create session modal is included so that if it is ongoing they can create a session -->
{% if is_opportunity_owner %}
    {% include 'opportunities_engagements/partials/create_session_modal.html' %}
    {% include 'opportunities_engagements/partials/complete_opportunity_modal.html' %}
    {% include 'opportunities_engagements/partials/complete_session_modal.html' %}
    {% include 'opportunities_engagements/partials/view_opportunity_engagees_modal.html' %}
    {% include 'opportunities_engagements/partials/view_session_attendees_modal.html' %}
{% endif %}

<!--If the user is engaged, the create engagement log modal is included so that if it is ongoing, the user can create an engagement log-->
{% if is_engaged %}
    {% include 'opportunities_engagements/partials/create_engagement_log_modal.html' %}
{% else %}
    <!--If the user is not engaged, the apply opportunity modal is included so that the user can apply to the opportunity-->
    {% include 'opportunities_engagements/partials/apply_opportunity_modal.html' %}
{% endif %}
<script>
    window.isOpportunityOwner = "{{ is_opportunity_owner|yesno:'true,false' }}" === "true";
</script>

<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg mt-6 flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
    
    <!-- Left Side: Main Opportunity Content -->
    <div class="w-full lg:w-2/3">
        <h1 class="text-3xl font-bold">{{ opportunity.title }}</h1>
        <p class="text-gray-700 mt-2">{{ opportunity.description }}</p>

        <div class="grid grid-cols-2 gap-4 mt-4">
            <p><strong>Status:</strong> {{ opportunity.status|title }}</p>
            <p><strong>Work Type:</strong> {{ opportunity.work_basis|title }}</p>
            <p><strong>Duration:</strong> {{ opportunity.duration|title }}</p>
            <p><strong>Location:</strong> {{ opportunity.required_location.formatted_address }}</p>
            <p><strong>Languages Required:</strong> {{ opportunity.languages|join:", " }}</p>
            <p><strong>Group Applications:</strong> {% if opportunity.can_apply_as_group %}Allowed{% else %}Not Allowed{% endif %}</p>
            {% if opportunity.ongoing %}
                <p><strong>Days Available:</strong> {{ opportunity.days_of_week|join:", " }}</p>
            {% else %}
                <p><strong>Date:</strong> {{ opportunity.opportunity_date }}</p>
                <p><strong>Time:</strong> {{ opportunity.opportunity_time_from }} - {{ opportunity.opportunity_time_to }}</p>
            {% endif %}
            <p><strong>Field of Interest:</strong> {{ opportunity.area_of_work|title }}</p>
            <p><strong>Requirements:</strong> {{ opportunity.requirements|join:", " }}</p>
            {% if is_opportunity_owner %}
                <button 
                    class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700"
                    hx-get="{% url 'opportunities_engagements:get_opportunity_engagements' opportunity.volunteer_opportunity_id %}"
                    hx-trigger="click"
                    hx-target="#engagees-modal-content">
                    View Engagees
                </button>
            {% endif %}
        </div>

        <!-- Sessions Section (Only for ongoing opportunities) -->
        {% if opportunity.ongoing %}
            <h2 class="text-xl font-semibold mt-6">Sessions</h2>

            {% if is_opportunity_owner %}
            <div class="flex space-x-4 mt-2">
                <button class="bg-blue-500 text-white px-4 py-2 rounded-md" onclick="filterSessions('upcoming')">Upcoming</button>
                <button class="bg-gray-500 text-white px-4 py-2 rounded-md" onclick="filterSessions('completed')">Completed</button>
                <button class="bg-red-500 text-white px-4 py-2 rounded-md" onclick="filterSessions('cancelled')">Cancelled</button>
                <button class="bg-gray-700 text-white px-4 py-2 rounded-md" onclick="filterSessions('all')">All</button>
            </div>
            {% endif %}

            <div id="sessions-container" class="grid grid-cols-2 gap-4 mt-4">
                {% for session in sessions %}
                    <div class="session-card bg-gray-100 p-4 rounded-lg" data-status="{{ session.status }}">
                        <h3 class="font-bold">{{ session.title }}</h3>
                        <p class="text-sm text-gray-700">{{ session.description }}</p>
                        <p><strong>Date:</strong> {{ session.session_date }}</p>
                        <p><strong>Time:</strong> {{ session.session_start_time }} - {{ session.session_end_time }}</p>
                        <p><strong>Status:</strong> {{ session.status|title }}</p>

                        {% if is_opportunity_owner %}
                            <button 
                            hx-patch="{% url 'opportunities_engagements:cancel_session' session.session_id %}"
                            hx-trigger="click"
                            hx-target="#loading-modal-content"
                            hx-swap="innerHTML"
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 mt-2">
                                Cancel Session
                            </button>
                            <button onclick="openCompleteSessionModal('{{ session.session_id }}')"
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 mt-2">
                                Complete Session
                            </button>
                            <button 
                                class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"
                                hx-get="{% url 'opportunities_engagements:get_session_engagements' session.session_id %}"
                                hx-trigger="click"
                                hx-target="#attendees-modal-content">
                                View Attendees
                            </button>
                        {% endif %}

                        {% if is_engaged %}
                            <div class="mt-2">
                                <button 
                                    hx-patch="{% url 'opportunities_engagements:confirm_attendance' session.session_engagement_id %}" 
                                    hx-trigger="click"
                                    hx-target="#loading-modal-content"
                                    hx-swap="innerHTML"
                                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-700 {% if opportunity.status != 'upcoming' %} disabled:opacity-50 cursor-not-allowed {% endif %}
                                    {% if session.status == 'can_go' %} opacity-50 cursor-not-allowed disabled {% endif %}">
                                    Can Go
                                </button>
                                <button 
                                    hx-patch="{% url 'opportunities_engagements:cancel_attendance' session.session_engagement_id %}" 
                                    hx-trigger="click"
                                    hx-target="#loading-modal-content"
                                    hx-swap="innerHTML"
                                    class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-700 {% if opportunity.status != 'upcoming' %} disabled:opacity-50 cursor-not-allowed {% endif %}
                                    {% if session.status == 'cant_go' %} opacity-50 cursor-not-allowed disabled {% endif %}">
                                    Can't Go
                                </button>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <p class="text-gray-500">No sessions available.</p>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Right Side: Organization Details + Buttons -->
    <div class="w-full lg:w-1/3 flex flex-col space-y-6">
        
        <!-- Organization Actions -->
        <div class="bg-gray-100 p-4 rounded-lg shadow-md">
            {% if is_opportunity_owner %}
                <h2 class="text-xl font-semibold mb-2">Manage Opportunity</h2>
                <div class="flex flex-col space-y-2">
                    <button onclick="openCompleteOpportunityModal('{{ opportunity.volunteer_opportunity_id }}')"
                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 {% if opportunity.status != 'upcoming' %} disabled:opacity-50 cursor-not-allowed {% endif %}">
                        Complete Opportunity
                    </button>
                    <button onclick="cancelOpportunity('{{ opportunity.volunteer_opportunity_id }}')"
                        class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 {% if opportunity.status != 'upcoming' %} disabled:opacity-50 cursor-not-allowed {% endif %}">
                        Cancel Opportunity
                    </button>
                    {% if opportunity.ongoing and opportunity.status == "upcoming" %}
                        <button onclick="document.getElementById('create-session-modal').classList.remove('hidden')"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Create Session
                        </button>
                    {% endif %}
                </div>
            {% else %}
                <h2 class="text-xl font-semibold mb-2">Your Status</h2>
                <div class="flex flex-col space-y-2">
                    {% if not has_applied %}
                        <button onclick="document.getElementById('apply-opportunity-modal').classList.remove('hidden')"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Apply for Opportunity
                        </button>
                    {% elif is_rejected %}
                        <button class="bg-red-500 text-white px-4 py-2 rounded-md cursor-not-allowed">
                            Rejected
                        </button>
                    {% elif has_applied and not is_engaged %}
                        <button class="bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed">
                            Applied
                        </button>
                    {% elif is_engaged %}
                        <button class="bg-green-600 text-white px-4 py-2 rounded-md cursor-not-allowed">
                            Engaged
                        </button>
                        {% if opportunity.ongoing and opportunity.status == "upcoming" %}
                            <button onclick="document.getElementById('create-engagement-log-modal').classList.remove('hidden')"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Create Engagement Log
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Organization Details Sidebar -->
        <div class="bg-gray-100 p-4 rounded-lg shadow-md">
            <img src="{{ organization.organization_profile_img }}" alt="Organization Logo" class="w-full h-40 object-cover rounded-lg mb-4">
            <h2 class="text-xl font-bold">{{ organization.organization_name }}</h2>
            <p class="text-gray-700 mt-2">{{ organization.organization_description }}</p>
            <p class="text-gray-600"><strong>Location:</strong> {{ organization.organization_address.raw }}</p>
        </div>
    </div>

    <script>
        var csrftoken = '{{ csrf_token }}';
    </script>
</div>
{% endblock %}